name: Latexdiff for Pull Request

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  latexdiff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
    - name: Checkout PR HEAD (new changes)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        path: pr

    - name: Checkout PR base (original)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        path: base

    - name: Install LaTeX and latexdiff
      run: |
        sudo apt-get update
        sudo apt-get install -y latexdiff texlive-latex-base texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended

    - name: Run latexdiff
      run: |
        latexdiff base/main.tex pr/main.tex > diff.tex

    - name: Compile diff.tex
      run: |
        pdflatex -interaction=nonstopmode diff.tex
        pdflatex -interaction=nonstopmode diff.tex
      # Double compile handles cross-references

    - name: Upload PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: latexdiff-pdf
        path: diff.pdf

    - name: Comment PDF on PR
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: diff-comment.md
        recreate: true

    - name: Prepare PR comment markdown
      env:
        RUN_ID: ${{ github.run_id }}
        REPO: ${{ github.repository }}
      run: |
        echo "ðŸ“ **Latexdiff output**" > diff-comment.md
        echo "" >> diff-comment.md
        echo "Download the PDF showing changes: [diff.pdf](https://github.com/${REPO}/actions/runs/${RUN_ID})" >> diff-comment.md





















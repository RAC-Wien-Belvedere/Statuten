name: Latexdiff for Pull Request

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  latexdiff:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'content')
    permissions:
      pull-requests: write
      contents: read

    steps:
    - name: Checkout PR base and full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup and Run git-latexdiff
      uses: xu-cheng/texlive-action@v2
      with:
        scheme: full
        run: |
          apk add git g++ make asciidoc
          cd /opt
          git clone https://gitlab.com/git-latexdiff/git-latexdiff.git
          cd /opt/git-latexdiff
          make install
          cd $GITHUB_WORKSPACE
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global --add safe.directory $GITHUB_WORKSPACE/.git
          git-latexdiff --verbose --main main.tex --no-view -o diff.pdf \
            --cleanup all --ignore-makefile -s ONLYCHANGEDPAGE \
            ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

    - name: Upload PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: latexdiff-pdf
        path: diff.pdf

    - name: Prepare PR comment markdown
      env:
        RUN_ID: ${{ github.run_id }}
        REPO: ${{ github.repository }}
      run: |
        echo "ðŸ“ **Latexdiff output**" > diff-comment.md
        echo "" >> diff-comment.md
        echo "Download the PDF showing changes: [diff.pdf](https://github.com/${REPO}/actions/runs/${RUN_ID})" >> diff-comment.md

    - name: Comment PDF on PR
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: diff-comment.md
        recreate: true
